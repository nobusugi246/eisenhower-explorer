// Generated by CoffeeScript 2.1.1
(function() {
  var clockVue, folderListVue, serverErrorHandler, serverStatusHandler, timeFormat, todoVue;

  moment.locale('ja');

  timeFormat = 'LL LTS';

  serverErrorHandler = function(xhr, msg, ext) {
    return UIkit.notification({
      message: `Server ${msg}: status = ${xhr.status}`,
      status: 'danger',
      pos: 'bottom-center',
      timeout: 2000
    });
  };

  serverStatusHandler = function(msg) {
    if (msg === 'ok') {
      return;
    }
    return UIkit.notification({
      message: `Server status: ${msg}`,
      status: 'warning',
      pos: 'bottom-center',
      timeout: 700
    });
  };

  clockVue = new Vue({
    el: '#menuClock',
    data: {
      time: moment().format(timeFormat)
    },
    mounted: function() {
      return setInterval(this.update, 1000);
    },
    methods: {
      update: function() {
        return this.time = moment().format(timeFormat);
      }
    }
  });

  todoVue = new Vue({
    el: '#matrix',
    data: {
      next_id: 9,
      items00: [
        {
          'id': 1,
          'text': 'test01',
          'folder': '',
          'url': ''
        },
        {
          'id': 2,
          'text': 'test02',
          'folder': '',
          'url': ''
        }
      ],
      items01: [
        {
          'id': 3,
          'text': 'test03',
          'folder': '',
          'url': ''
        },
        {
          'id': 4,
          'text': 'test04',
          'folder': '',
          'url': ''
        }
      ],
      items02: [
        {
          'id': 5,
          'text': 'test05',
          'folder': '',
          'url': ''
        },
        {
          'id': 6,
          'text': 'test06',
          'folder': '',
          'url': ''
        }
      ],
      items03: [
        {
          'id': 7,
          'text': 'test07',
          'folder': '',
          'url': ''
        },
        {
          'id': 8,
          'text': 'test08',
          'folder': '',
          'url': ''
        }
      ]
    },
    methods: {
      stoped: function(e) {
        console.log('stop at ' + moment().format(timeFormat));
        return console.log(e);
      }
    }
  });

  folderListVue = new Vue({
    el: '#folderList',
    data: {
      folderList00: [],
      folderList01: [],
      folderList02: [],
      current00: '',
      current01: '',
      current02: '',
      sethover: {}
    },
    created: function() {
      return this.initialize('/');
    },
    methods: {
      open: function(e) {
        var target_folder;
        target_folder = e.target.innerText;
        console.log(target_folder);
        return $.ajax({
          url: '/open',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            'path_name': target_folder
          }),
          success: function(e) {
            console.log('opened.');
            return serverStatusHandler(e.status);
          },
          error: function(xhr, msg, ext) {
            return serverErrorHandler(xhr, msg, ext);
          }
        });
      },
      list_mouseenter: function(e) {
        var currentFolder, folderList, list_name;
        list_name = _.trim(e.target.attributes.name.value).slice(-2);
        folderList = this.folderList00;
        currentFolder = this.current00;
        if (list_name === '01') {
          folderList = this.folderList01;
          currentFolder = this.current01;
        }
        if (list_name === '02') {
          folderList = this.folderList02;
          currentFolder = this.current02;
        }
        return this.sethover = setTimeout(function() {
          var i, index, item, len, results, targetFolder;
          results = [];
          for (index = i = 0, len = folderList.length; i < len; index = ++i) {
            item = folderList[index];
            if (!item.isfile) {
              targetFolder = currentFolder + "/" + item.name;
              targetFolder = _.replace(targetFolder, '//', '/');
              console.log(targetFolder + ": " + index);
              results.push($.ajax({
                url: "/size",
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                  'path_name': targetFolder,
                  'list_name': list_name,
                  'index': index
                }),
                success: function(e) {
                  console.log(e);
                  folderListVue.setFolderListSize(e.list_name, e.index, e.size);
                  return serverStatusHandler(e.list_name + ": " + e.index + ", " + e.size);
                },
                error: function(xhr, msg, ext) {
                  return serverErrorHandler(xhr, msg, ext);
                }
              }));
            } else {
              results.push(void 0);
            }
          }
          return results;
        }, 2000);
      },
      mouseenter: function(e) {
        var folderList, folderName, index, list_name, parentFolder, targetFolder;
        //console.log("mouse enter")
        folderName = _.trim(e.target.lastChild.innerText);
        index = _.toInteger(_.trim(e.target.firstChild.innerText));
        parentFolder = _.trim(e.target.parentNode.parentNode.firstChild.innerText);
        targetFolder = parentFolder + '/' + folderName;
        targetFolder = _.replace(targetFolder, '//', '/');
        list_name = _.trim(e.target.attributes.name.value).slice(-2);
        folderList = this.folderList00;
        if (list_name === '01') {
          folderList = this.folderList01;
        }
        if (list_name === '02') {
          folderList = this.folderList02;
        }
        if (!folderList[index].isfile) {
          // console.log(index + ", " + targetFolder)
          // console.log(e)
          return this.sethover = setTimeout(function() {
            e.target.classList.add('uk-animation-shake');
            return $.ajax({
              url: "/size",
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({
                'path_name': targetFolder,
                'list_name': list_name,
                'index': index
              }),
              success: function(e) {
                console.log(e);
                folderListVue.setFolderListSize(e.list_name, e.index, e.size);
                return serverStatusHandler(e.list_name + ": " + e.index + ", " + e.size);
              },
              error: function(xhr, msg, ext) {
                return serverErrorHandler(xhr, msg, ext);
              }
            });
          }, 2000);
        }
      },
      mouseleave: function(e) {
        // console.log("mouse leave")
        e.target.classList = [];
        return clearTimeout(this.sethover);
      },
      clicked: function(e) {
        var folderList, index, list_name, target_folder;
        console.log('clicked.');
        index = _.toInteger(_.trim(e.target.parentElement.childNodes[0].innerText));
        console.log('index: ' + index);
        if (index < 0) {
          this.initialize(this.current00 + '/..');
          return;
        }
        if (!e.target.attributes.name) {
          return;
        }
        list_name = _.trim(e.target.attributes.name.value).slice(-2);
        folderList = this.folderList00;
        if (list_name === '01') {
          folderList = this.folderList01;
        }
        if (list_name === '02') {
          folderList = this.folderList02;
        }
        if (!folderList[index].isfile) { // フォルダをクリック
          if (list_name === '00') {
            target_folder = this.current00 + '/' + folderList[index].name;
            console.log(target_folder);
            return $.ajax({
              url: "/find",
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({
                'path_name': target_folder
              }),
              success: function(e) {
                folderListVue.update01(e.current, e.contents);
                return serverStatusHandler(e.status);
              },
              error: function(xhr, msg, ext) {
                return serverErrorHandler(xhr, msg, ext);
              }
            });
          } else if (list_name === '01') {
            target_folder = this.current01 + '/' + folderList[index].name;
            console.log(target_folder);
            return $.ajax({
              url: "/find",
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({
                'path_name': target_folder
              }),
              success: function(e) {
                folderListVue.update02(e.current, e.contents);
                return serverStatusHandler(e.status);
              },
              error: function(xhr, msg, ext) {
                return serverErrorHandler(xhr, msg, ext);
              }
            });
          } else {
            target_folder = this.current02 + '/' + folderList[index].name;
            console.log(target_folder);
            return $.ajax({
              url: "/find",
              method: 'POST',
              contentType: 'application/json',
              data: JSON.stringify({
                'path_name': target_folder
              }),
              success: function(e) {
                folderListVue.update02_and_shift(e.current, e.contents);
                return serverStatusHandler(e.status);
              },
              error: function(xhr, msg, ext) {
                return serverErrorHandler(xhr, msg, ext); // ファイルをクリック
              }
            });
          }
        } else {
          return console.log('file: ' + folderList[index].name);
        }
      },
      update00: function(current, folder) {
        this.current00 = _.replace(current, '//', '/');
        return this.folderList00 = folder;
      },
      update01: function(current, folder) {
        this.current01 = _.replace(current, '//', '/');
        this.current02 = '';
        this.folderList01 = folder;
        return this.folderList02 = [];
      },
      update02: function(current, folder) {
        this.current02 = _.replace(current, '//', '/');
        return this.folderList02 = folder;
      },
      update02_and_shift: function(current, folder) {
        this.current00 = this.current01;
        this.current01 = this.current02;
        this.current02 = _.replace(current, '//', '/');
        this.folderList00 = this.folderList01;
        this.folderList01 = this.folderList02;
        return this.folderList02 = folder;
      },
      update: function(current, folders) {
        this.current00 = _.replace(current, '//', '/');
        this.current01 = '';
        this.current02 = '';
        this.folderList00 = folders[0];
        this.folderList01 = folders[1];
        return this.folderList02 = folders[2];
      },
      setFolderListSize: function(list_name, index, size) {
        var folderList;
        folderList = this.folderList00;
        if (list_name === '01') {
          folderList = this.folderList01;
        }
        if (list_name === '02') {
          folderList = this.folderList02;
        }
        return folderList[index].size = size;
      },
      initialize: function(current) {
        return $.ajax({
          url: "/find",
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({
            'path_name': current
          }),
          success: function(e) {
            folderListVue.update(e.current, [e.contents, [], []]);
            return serverStatusHandler(e.status);
          },
          error: function(xhr, msg, ext) {
            return serverErrorHandler(xhr, msg, ext);
          }
        });
      }
    }
  });

  console.log(moment().format(timeFormat) + " started.");

  // -------------------------------------------------------
  $(function() {
    $('body').removeClass('uk-invisible');
    return $('#iteminput').focus();
  });

}).call(this);
